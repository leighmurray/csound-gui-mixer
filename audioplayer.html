<!DOCTYPE html>
<html>
<!--
 csound.js Audio file player example
 Copyright (C) 2013 V Lazzarini
-->

<head>
    <title>WebAudio Csound</title>
    <style type="text/css">
    html, body {
      font-family: Monospace;
      color: #bf94f7;
      background-color: #000055;
    }

    #console {
        font-family:  Monospace;
        color: #b5b6ff;
        background-color: #000000;
        font-size: 16px;
        width: 805px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-style: solid;
        padding: 20px 0px;
      }

     #filebut {
       padding: 20px 0px;
     }
     input[type=file] {
       font-family: Monospace;
       font-size: 24px;
       background-color: #b5b6ff;
       color: #000000;
     }

     H1 {
       font-size: 36px;
     }

     button {
        margin: auto;
        font-family: Monospace;
        width: 805px;
        padding: 10px 0px;
        font-size: 24px;
        background-color: #b5b6ff;
     }
    </style>
    <script type="text/javascript" src="js/CsoundObj.js"></script>
    <script type="text/javascript">
        // called by csound.js
        function moduleDidLoad() {
            csound = new CsoundObj();
            SetParam("cf", 'Hz', 1., 0.);
        }

        function attachListeners() {
            document.getElementById('playButton').
            addEventListener('click', togglePlay);
            document.getElementById('files').
            addEventListener('change', handleFileSelect, false);
        }
        // attach callbacks to sliders
        function attachListeners() {
            document.getElementById("freq").
            addEventListener("input", SetFreq);
            document.getElementById("amp").
            addEventListener("input", SetAmp);
            document.getElementById("cf").
            addEventListener("input", SetCf);
        }


        // set amplitude
        function SetAmp() {
            SetParam('amp', '', 1000., 0.0);
        }

        // set fundamental
        function SetFreq() {
            SetParam('freq', 'Hz', 1., 440.);
        }

        // set centre frequency
        function SetCf() {
            SetParam('cf', 'Hz', 1., 0.);
        }

        function clear_console() {
            var element = document.getElementById('console');
            element.value = ' ';
            document.getElementById('pause').
            addEventListener('click', pause);
        }
        
        // set parameter
        function SetParam(name, label, scal, off) {
            var val = document.getElementById(name).value / scal + off;
            csound.setControlChannel(name, val);
            console.log(name + ": " + val + " " + label);
        }
        
        var fcopied = false;
        var count = 0;

        function handleMessage(message) {
            var element = document.getElementById('console');
            element.value += message;
            count += 1;
            if (count == 1000) {
                element.value = ' ';
                count = 0;
            }
        }

        var playing = false;
        var started = false;
        var loaded = false;

        function togglePlay() {
            if (loaded && fcopied) {
                if (!playing) {
                    if (started) csound.Play();
                    else {
                        CsoundObj.CSOUND_AUDIO_CONTEXT.resume();
                        csound.PlayCsd("gmwav.csd");
                        started = true;
                    }
                    document.getElementById('playButton').innerText = "Pause";
                    playing = true;
                } else {
                    csound.Pause()
                    document.getElementById('playButton').innerText = "Play";
                    playing = false;
                }
            }
        }

        function handleFileSelect(evt) {
            if (!loaded) {
                var files = evt.target.files;
                var f = files[0];
                var objectURL = window.URL.createObjectURL(f);
                csound.CopyUrlToLocal(objectURL, "audiofile.wav", function() {
                    loaded = true;
                    console.log("Ready to play. \n");
                });
            } else {
                csound.UpdateStatus("to load a new file, first refresh page!")
            }
        }
    </script>
</head>

<body>
    <H1> Audio File Player </H1>
    <div id="filebut">
    <input type="file" id="files" name="file" />
  </div>
  <div id="controls">
    <p>
      <input type="range" name="frequency" id="freq" step="1" value="50" min="0" max="100"> fundamental </p>
    <p>
      <input type="range" name="frequency" id="amp" step="1" value="500" min="0" max="1000"> amplitude</p>
    <p>
      <input type="range" name="frequency" id="cf" step="1" value="880" min="880" max="3000"> filter frequency</p>
  </div>
    <textarea class="console" cols="65" rows="20" id="console">
      Csound: not loaded</textarea>
    <p>
        <button id="playButton">Play</button>
    </p>
</body>

</html>
